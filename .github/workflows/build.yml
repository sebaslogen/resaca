name: Unit tests

on:
  push:
  pull_request:

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-14-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Run API Check
        run: ./gradlew apiCheck
        env:
          CI_FLOW: ${{ github.workflow }}

      - name: Run Lint
        run: ./gradlew lint
        env:
          CI_FLOW: ${{ github.workflow }}

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: 'latest-stable'

      - name: Prepare and open Simulator
        run: |
          xcrun simctl create iphone-15-pro "iPhone 15 Pro"
          xcrun simctl boot iphone-15-pro
          open /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app

      - name: Run tests with code coverage
        run: ./gradlew check
        env:
          CI_FLOW: ${{ github.workflow }}
        
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
